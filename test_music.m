clc;clear;close all;clear playsnd;clear sound;

%% Define the Notes
% music_note = {'G3','C4', 'C4', 'E4', 'A4', 'E4', 'G4', ...
% 'G4', 'A4', 'G4', 'E4', 'F4', 'E4', 'D4', ...
% 'A3', 'D4', 'D4', 'F4', 'B4', 'B4', 'A4', ...
% 'G4', 'F4', 'F4', 'E4', 'A3', 'B3', 'C4', 'D4'};
% music_dur = {16/3,16,16/3,16,16/3,16,4,...
%             16/3,16,16/3,16,16/3,16,4,...
%             16/3,16,16/3,16,16/3,16,16/3,16,...
%             4,16/3,16,8,4,8,1};
music_dur = {
%     2,2,...
%             2,2,...
%             2,2,...
%             2,2,...
%             2,2,...
%             2,2,...
%             2,2,...
%             2,2,...
%             2,4,4,...
%             2,4,4,...
%             2,4,4,...
%             2,4,4,...
%             8,8,8,8,4,4,...
%             4,4,8,8,8,8,...
%             8,8,8,8,8,8,8,8,...
%             8,8,4,8,8,8,8,...
%             8,8,8,8,4,4,...
%             4,4,8,8,8,8,...
%             8,8,8,8,8,8,8,8,...
%             8,8,4,16/3,16,8,16,16,...
%             16/3,16,16,16,16,4,16,16,16,16,16,...
%             16/3,16/3,16,16,8,16,16/3,8,...
%             4,8,8,4,8,8,...
%             4,16,16,8,16/3,8,16,16,16,...
%             16/3,16,16,16,16,4,16,16,16,16,16,...
%             16/3,16/3,16,16,8,16,8,8,...
%             4,8,8,4,8,8,...
%             4,16,16,8,16/3,8,16,16,16,...
            8,16,16,8,16,16,16,16,16,16,16,16,16,16,...
            8,16,16,8,16,16,16,16,16,16,16,16,16,16,...
            8,16,16,8,16,16,16,16,16,16,16,16,16,16,...
            8,16,16,8,16,16,16,16,16,16,16,16,16,16,...
            8,16,16,8,16,16,16,16,16,16,16,16,16,16,...
            8,16,16,8,16,16,16,16,16,16,16,16,16,16,...
            8,16,16,8,16,16,16,16,16,16,16,16,16,16,...
            8,16,16,8,16,16,16,16,16,16,16,16,16,16,...
            8,16,16,8,16,16,16,16,16,16,16,16,16,16,...
            8,16,16,8,16,16,16,16,16,16,16,16,16,16,...
            8,16,16,8,16,16,16,16,16,16,16,16,16,16,...
            8,16,16,8,16,16,16,16,16,16,16,16,16,16,...
            1
            };
% 定义主旋律
music_note = {
%     'E4','D4',...
%         'C4','B3',...
%         'A3','G3',...
%         'A3','B3',...
%         'E5','D5',...
%         'C5','B4',...
%         'A4','G4',...
%         'A4','B4',...
%         'E5','D5','F4',...
%         'C5','B4','G4',...
%         'A4','G4','E4',...
%         'A4','G4','F4',...
%         'C5','B4','C5','E4','G4','B4',...
%         'C5','E5','G4','E4','G4','A4',...
%         'F5','E5','D5','F5','E5','D5','C5','B4',...
%         'A4','F4','C5','B4','G4','C5','B4',...
%         'C5','B4','C5','E4','G4','B4',...
%         'C5','E5','G4','E4','G4','A4',...
%         'F5','E5','D5','F5','E5','D5','C5','B4',...
%         'A4','G4','F4','C5','G4','B4','D5','G5',...
%         'E5','G4','E5','D5','C5','D5','E5','F5','E5','D5','E5',...
%         'C5','C5','B4','C5','B4','G4','E4','G4',...
%         'A4','B4','C5','G4','E4','G4',...
%         'A4','F4','A4','C5','C5','B4','C5','D5','G4',...
%         'E5','G4','E5','D5','C5','D5','E5','F5','E5','D5','E5',...
%         'C5','C5','B4','C5','B4','G4','E4','G4',...
%         'A4','B4','C5','G4','E4','G4',...
%         'A4','F4','A4','C5','C5','B4','C5','D5','G4',...
        'G5','E5','F5','G5','E5','F5','G5','B4','A4','B4','C5','D5','E5','F5',...
        'E5','C5','D5','E5','E4','F4','G4','A4','G4','F4','G4','C5','B4','C5',...
        'A4','C5','B4','A4','G4','F4','G4','F4','E4','F4','G4','A4','B4','C5',...
        'A4','C5','B4','C5','B4','C5','B4','A4','B4','C5','D5','E5','F5','G5',...
        'G5','E5','F5','G5','E5','F5','G5','B4','A4','B4','C5','D5','E5','F5',...
        'E5','C5','D5','E5','E4','F4','G4','A4','G4','F4','G4','C5','B4','C5',...
        'A4','C5','B4','A4','G4','F4','G4','F4','E4','F4','G4','A4','B4','C5',...
        'A4','C5','B4','C5','B4','C5','B4','A4','B4','C5','D5','E5','F5','G5',...
        'E5','C5','D5','E5','D5','C5','D5','B4','C5','D5','E5','D5','C5','B4',...
        'C5','A4','B4','C5','C5','D5','E5','F5','E5','D5','E5','C5','B4','C5',...
        'A4','C5','B4','A4','G4','F4','G4','F4','E4','F4','G4','A4','B4','C5',...
        'A4','C5','B4','C5','B4','A4','B4','C5','D5','C5','B4','C5','A4','B4',...
        'C5'
        };



rpm = 70;
time_sig = [4,4];

%% Translate the Notes to Frequencies
music_freq = zeros(1,length(music_note));
for i = 1:length(music_note)
    if (music_note{i}=='N')
        music_freq(i) = 0;
    else
        this_note = music_note{i};
        name = this_note(1:end-1);
        % disp(name);
        octave = str2double(this_note(end));
        music_freq(i) = note2freq(name,octave);
    end
end

%% Generate the Music
music = zeros(1,0);
fs = 8000; % Sampling frequency
amp = 1; % Amplitude
for i = 1:length(music_note)
    duration = (60/rpm)*(time_sig(1)/music_dur{i}); % Duration in seconds 
    music = [music, ...
        amp*sin(2*pi*music_freq(i)*(0:1/fs:duration))];
end

%% Play the Music
% sound(music,fs);
audiowrite('5-3.wav',music,fs);

%% Plot the Music
t = 0:1/fs:(length(music)-1)/fs;
% figure(1);
% plot(t,music);
% xlabel('Time (s)');
% ylabel('Amplitude');
% title('Music');

music_enve = zeros(1,0);
for i = 1:length(music_note)
    duration = (60/rpm)*(time_sig(1)/music_dur{i}); % Duration in seconds 
    envelope = exp_enve(0,duration,(0:1/fs:duration));
    music_enve = [music_enve, ...
        amp*sin(2*pi*music_freq(i)*(0:1/fs:duration)).*envelope];
end

% sound(music_enve,fs);
audiowrite('5-4.wav',music_enve,fs);
N_each = length(music_enve)/4;
figure(2);
for i = 1:4
    subplot(4,1,i);
    plot(t((i-1)*N_each+1:i*N_each),music_enve((i-1)*N_each+1:i*N_each));
    xlabel('Time (s)');
    ylabel('Amplitude');
    if i == 1
        title('Music');
    end
end
set(gcf,'Position',[100,100,1200,600]);
print(gcf,'5-4_enve.png','-dpng','-r300');

%% Add harmonics
music_harm = zeros(1,0);
n_harm = 4; amp_list = [1,0.3,0.2,0.2,0.1,0.1,0.1,0.1];
for i = 1:length(music_note)
    duration = (60/rpm)*(time_sig(1)/music_dur{i}); % Duration in seconds 
    envelope = exp_enve(0,duration,(0:1/fs:duration));
    this_wave = zeros(1,length(0:1/fs:duration));
    for j = 1:n_harm
        this_wave = this_wave + amp*sin(2*pi*j*music_freq(i)*(0:1/fs:duration)).*envelope*amp_list(j);
    end
    music_harm = [music_harm, this_wave];
end

sound(music_harm,fs);
audiowrite('5-5.wav',music_harm,fs);
N_each = length(music_harm)/4;
figure(3);
for i = 1:4
    subplot(4,1,i);
    plot(t((i-1)*N_each+1:i*N_each),music_harm((i-1)*N_each+1:i*N_each));
    xlabel('Time (s)');
    ylabel('Amplitude');
    if i == 1
        title('Music');
    end
end
set(gcf,'Position',[100,100,1200,600]);
print(gcf,'5-5_harm.png','-dpng','-r300');

function freq = note2freq(name, octave)
    name_set = {'C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'};
    freq_set = {261.63, 277.18, 293.66, 311.13, 329.63, 349.23, 369.99, 392.00, 415.30, 440.00, 466.16, 493.88};
    freq = freq_set{strcmp(name_set, name)} * 2^(octave-4);
end

function envelope = exp_enve(t_start,t_end,time)
    envelope = zeros(1,length(time));
    t_single = t_end - t_start;
    state1 = 0.005;
    t_end1 = t_start + state1 .* t_single;
    envelope = envelope + 1./(t_end1 - t_start) .* (time - t_start).*(time >= t_start & time <= t_end1);
    envelope = envelope + exp(-3.*(time - t_end1)./(t_end-t_end1).*((time >= t_end1 & time <= t_end)));
end